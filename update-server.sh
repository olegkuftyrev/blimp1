#!/usr/bin/env bash
# ============================================================================
# –ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# ============================================================================
# –í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø–æ—Å–ª–µ: ssh root@164.90.147.86
# ============================================================================

set -e

echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."

cd /opt/blimp1

# –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
echo "üì• –ü–æ–ª—É—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ GitHub..."
git fetch origin
git reset --hard origin/main

# –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º
echo "üì¶ –û–±–Ω–æ–≤–ª—è–µ–º backend –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
cd backend
npm ci --production=false

echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º backend..."
node ace build --ignore-ts-errors

echo "üóÑÔ∏è –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏..."
node ace migration:run

echo "üì¶ –û–±–Ω–æ–≤–ª—è–µ–º frontend –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
cd ../frontend
npm ci

echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º frontend..."
npm run build

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
cd /opt/blimp1
pm2 restart all

echo ""
echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
pm2 status

echo ""
echo "üìã –õ–æ–≥–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫):"
pm2 logs --lines 20

